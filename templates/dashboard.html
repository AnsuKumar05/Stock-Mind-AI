{% extends "base.html" %}

{% block title %}Dashboard - AI Stock Market Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4">
            <i class="fas fa-tachometer-alt me-3"></i>Dashboard
        </h1>
        <p class="lead">Welcome back! Here's your prediction overview.</p>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ predictions|length }}</h4>
                        <p class="card-text">CSV Predictions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ investment_predictions|length }}</h4>
                        <p class="card-text">Investment Predictions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-money-bill-trend-up fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ company_comparisons|length }}</h4>
                        <p class="card-text">Company Comparisons</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-balance-scale fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ uploads|length }}</h4>
                        <p class="card-text">Files Uploaded</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-upload fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-upload me-2"></i>Upload CSV
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('investment_prediction') }}" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-money-bill-trend-up me-2"></i>Investment Prediction
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('company_comparison') }}" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-balance-scale me-2"></i>Compare Companies
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-info btn-lg w-100" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="fas fa-question-circle me-2"></i>Help
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Recent Activity Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
            </div>
            <div class="card-body">

                <!-- TAB HEADERS -->
                <ul class="nav nav-tabs" id="activityTabs" role="tablist">

                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if active_tab=='csv' %}active{% endif %}"
                                id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button">
                            <i class="fas fa-chart-line me-1"></i>CSV Predictions
                        </button>
                    </li>

                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if active_tab=='investment' %}active{% endif %}"
                                id="investment-tab" data-bs-toggle="tab" data-bs-target="#investment" type="button">
                            <i class="fas fa-money-bill-trend-up me-1"></i>Investments
                        </button>
                    </li>

                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if active_tab=='comparison' %}active{% endif %}"
                                id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button">
                            <i class="fas fa-balance-scale me-1"></i>Comparisons
                        </button>
                    </li>

                </ul>


                <!-- TAB CONTENT -->
                <div class="tab-content" id="activityTabContent">

                    <!-- ================= CSV PREDICTIONS ================= -->
                    <div class="tab-pane fade {% if active_tab=='csv' %}show active{% endif %}" id="csv">

                        {% if predictions %}
                        <div class="table-responsive mt-3">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>File</th>
                                        <th>Predicted Price</th>
                                        <th>Change</th>
                                        <th>Confidence</th>
                                        <th>Model</th>
                                        <th class="text-center">Action</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for pred in predictions %}
                                    <tr>

                                        <td>{{ pred.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

                                        <td><i class="fas fa-file-csv me-1"></i>{{ pred.upload.original_filename[:20] }}...</td>

                                        <td>{{ pred.predicted_price|inr }}</td>

                                        <td>
                                            {% if pred.predicted_change_percent %}
                                                {% if pred.predicted_change_percent > 0 %}
                                                    <span class="text-success"><i class="fas fa-arrow-up me-1"></i>+{{ "%.2f"|format(pred.predicted_change_percent) }}%</span>
                                                {% else %}
                                                    <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ "%.2f"|format(pred.predicted_change_percent) }}%</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>

                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar"
                                                     style="width: {{ (pred.confidence_score * 100)|round }}%">
                                                     {{ (pred.confidence_score * 100)|round }}%
                                                </div>
                                            </div>
                                        </td>

                                        <td>{{ pred.model_type }}</td>

                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-1">

                                                <!-- View -->
                                                <a href="{{ url_for('view_prediction', id=pred.id) }}"
                                                   class="btn btn-sm btn-outline-info px-3">
                                                    <i class="fas fa-eye"></i>
                                                </a>

                                                <!-- Delete -->
                                                <form action="{{ url_for('delete_prediction', id=pred.id) }}"
                                                      method="POST" class="m-0">
                                                    <button class="btn btn-sm btn-outline-danger px-3"
                                                            onclick="return confirm('Delete this prediction?');">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>

                                            </div>
                                        </td>

                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>
                        </div>

                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <h5>No CSV predictions yet</h5>
                        </div>
                        {% endif %}

                    </div>


                    <!-- ================= INVESTMENT PREDICTIONS ================= -->
                    <div class="tab-pane fade {% if active_tab=='investment' %}show active{% endif %}" id="investment">

                        {% if investment_predictions %}
                        <div class="table-responsive mt-3">

                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Company</th>
                                        <th>Investment</th>
                                        <th>Return</th>
                                        <th>Profit</th>
                                        <th>Status</th>
                                        <th>Confidence</th>
                                        <th class="text-center">Action</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for invest in investment_predictions %}
                                    <tr>

                                        <td>{{ invest.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

                                        <td>
                                            <strong>{{ invest.company.name }}</strong><br>
                                            <small class="text-muted">{{ invest.company.symbol }}</small>
                                        </td>

                                        <td>{{ invest.investment_amount|inr }}</td>
                                        <td>{{ invest.predicted_return|inr }}</td>

                                        <td>
                                            {% if invest.predicted_profit > 0 %}
                                                <span class="text-success"><i class="fas fa-arrow-up me-1"></i>+{{ invest.predicted_profit|inr }}</span>
                                            {% else %}
                                                <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ invest.predicted_profit|inr }}</span>
                                            {% endif %}
                                            <br><small>{{ invest.profit_percentage }}%</small>
                                        </td>

                                        <td>
                                            {% if invest.is_profitable %}
                                                <span class="badge bg-success">Profitable</span>
                                            {% else %}
                                                <span class="badge bg-danger">Loss</span>
                                            {% endif %}
                                        </td>

                                        <td>
                                            <div class="progress" style="height:20px;">
                                                <div class="progress-bar"
                                                     style="width: {{ (invest.confidence_score * 100)|round }}%">
                                                     {{ (invest.confidence_score * 100)|round }}%
                                                </div>
                                            </div>
                                        </td>

                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-1">

                                                <a href="{{ url_for('view_investment', id=invest.id) }}"
                                                   class="btn btn-sm btn-outline-info px-3">
                                                    <i class="fas fa-eye"></i>
                                                </a>

                                                <form action="{{ url_for('delete_investment', id=invest.id) }}" method="POST" class="m-0">
                                                    <button class="btn btn-sm btn-outline-danger px-3"
                                                            onclick="return confirm('Delete this investment?');">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>

                                            </div>
                                        </td>

                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>

                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-money-bill-trend-up fa-3x text-muted mb-3"></i>
                            <h5>No investment predictions yet</h5>
                        </div>
                        {% endif %}

                    </div>


                    <!-- ================= COMPANY COMPARISON ================= -->
                    <div class="tab-pane fade {% if active_tab=='comparison' %}show active{% endif %}" id="comparison">

                        {% if company_comparisons %}
                        <div class="table-responsive mt-3">

                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Company 1</th>
                                    <th>Company 2</th>
                                    <th class="no-wrap">Return 1</th>
                                    <th class="no-wrap">Return 2</th>
                                    <th>Recommended</th>
                                    <th>Confidence</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            
                                <tbody>
                                    {% for comp in company_comparisons %}
                                    <tr>

                                        <td>{{ comp.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

                                        <td><strong>{{ comp.company1.name }}</strong><br>
                                            <small class="text-muted">{{ comp.company1.symbol }}</small></td>

                                        <td><strong>{{ comp.company2.name }}</strong><br>
                                            <small class="text-muted">{{ comp.company2.symbol }}</small></td>

                                        <td class="{{ 'text-success' if comp.company1_predicted_return > 0 else 'text-danger' }}">
                                            {{ "%.2f"|format(comp.company1_predicted_return) }}%
                                        </td>

                                        <td class="{{ 'text-success' if comp.company2_predicted_return > 0 else 'text-danger' }}">
                                            {{ "%.2f"|format(comp.company2_predicted_return) }}%
                                        </td>

                                        <td>
                                            <span class="badge bg-success">
                                                {{ comp.recommended_company_id == comp.company1_id and comp.company1.name or comp.company2.name }}
                                            </span>
                                        </td>

                                        <td>
                                            <div class="progress" style="height:20px;">
                                                <div class="progress-bar"
                                                     style="width: {{ (comp.confidence_score * 100)|round }}%">
                                                     {{ (comp.confidence_score * 100)|round }}%
                                                </div>
                                            </div>
                                        </td>

                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-1">

                                                <a href="{{ url_for('view_comparison', id=comp.id) }}"
                                                   class="btn btn-sm btn-outline-info px-3">
                                                    <i class="fas fa-eye"></i>
                                                </a>

                                                <form action="{{ url_for('delete_comparison', id=comp.id) }}" method="POST" class="m-0">
                                                    <button class="btn btn-sm btn-outline-danger px-3"
                                                            onclick="return confirm('Delete this comparison?');">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>

                                            </div>
                                        </td>

                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>

                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-balance-scale fa-3x text-muted mb-3"></i>
                            <h5>No company comparisons yet</h5>
                        </div>
                        {% endif %}

                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}