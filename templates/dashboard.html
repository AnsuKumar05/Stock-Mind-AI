{% extends "base.html" %}

{% block title %}Dashboard - AI Stock Market Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4">
            <i class="fas fa-tachometer-alt me-3"></i>Dashboard
        </h1>
        <p class="lead">Welcome back! Here's your prediction overview.</p>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ predictions|length }}</h4>
                        <p class="card-text">CSV Predictions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ investment_predictions|length }}</h4>
                        <p class="card-text">Investment Predictions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-money-bill-trend-up fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ company_comparisons|length }}</h4>
                        <p class="card-text">Company Comparisons</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-balance-scale fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ uploads|length }}</h4>
                        <p class="card-text">Files Uploaded</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-upload fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-upload me-2"></i>Upload CSV
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('investment_prediction') }}" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-money-bill-trend-up me-2"></i>Investment Prediction
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('company_comparison') }}" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-balance-scale me-2"></i>Compare Companies
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-info btn-lg w-100" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="fas fa-question-circle me-2"></i>Help
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="activityTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button" role="tab">
                            <i class="fas fa-chart-line me-1"></i>CSV Predictions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="investment-tab" data-bs-toggle="tab" data-bs-target="#investment" type="button" role="tab">
                            <i class="fas fa-money-bill-trend-up me-1"></i>Investments
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab">
                            <i class="fas fa-balance-scale me-1"></i>Comparisons
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="activityTabContent">
                    <!-- CSV Predictions Tab -->
                    <div class="tab-pane fade show active" id="csv" role="tabpanel">
                        {% if predictions %}
                        <div class="table-responsive mt-3">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>File</th>
                                        <th>Predicted Price</th>
                                        <th>Change</th>
                                        <th>Confidence</th>
                                        <th>Model</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pred in predictions %}
                                    <tr>
                                        <td>{{ pred.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <i class="fas fa-file-csv me-1"></i>
                                            {{ pred.upload.original_filename[:20] }}...
                                        </td>
                                        <td>{{ pred.predicted_price|inr }}</td>
                                        <td>
                                            {% if pred.predicted_change_percent %}
                                                {% if pred.predicted_change_percent > 0 %}
                                                    <span class="text-success">
                                                        <i class="fas fa-arrow-up me-1"></i>
                                                        +{{ "%.2f"|format(pred.predicted_change_percent) }}%
                                                    </span>
                                                {% else %}
                                                    <span class="text-danger">
                                                        <i class="fas fa-arrow-down me-1"></i>
                                                        {{ "%.2f"|format(pred.predicted_change_percent) }}%
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ (pred.confidence_score * 100)|round }}%">
                                                    {{ (pred.confidence_score * 100)|round }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ pred.model_type }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <h5>No CSV predictions yet</h5>
                            <p class="text-muted">Upload a CSV file to start making predictions</p>
                            <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
                                <i class="fas fa-upload me-2"></i>Upload CSV
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Investment Predictions Tab -->
                    <div class="tab-pane fade" id="investment" role="tabpanel">
                        {% if investment_predictions %}
                        <div class="table-responsive mt-3">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Company</th>
                                        <th>Investment</th>
                                        <th>Predicted Return</th>
                                        <th>Profit</th>
                                        <th>Status</th>
                                        <th>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invest in investment_predictions %}
                                    <tr>
                                        <td>{{ invest.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <strong>{{ invest.company.name }}</strong><br>
                                            <small class="text-muted">{{ invest.company.symbol }}</small>
                                        </td>
                                        <td>{{ invest.investment_amount|inr }}</td>
                                        <td>{{ invest.predicted_return|inr }}</td>
                                        <td>
                                            {% if invest.predicted_profit > 0 %}
                                                <span class="text-success">
                                                    <i class="fas fa-arrow-up me-1"></i>
                                                    +{{ invest.predicted_profit|inr }}
                                                    <br><small>(+{{ "%.2f"|format(invest.profit_percentage) }}%)</small>
                                                </span>
                                            {% else %}
                                                <span class="text-danger">
                                                    <i class="fas fa-arrow-down me-1"></i>
                                                    {{ invest.predicted_profit|inr }}
                                                    <br><small>({{ "%.2f"|format(invest.profit_percentage) }}%)</small>
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if invest.is_profitable %}
                                                <span class="badge bg-success">Profitable</span>
                                            {% else %}
                                                <span class="badge bg-danger">Loss</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ (invest.confidence_score * 100)|round }}%">
                                                    {{ (invest.confidence_score * 100)|round }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-money-bill-trend-up fa-3x text-muted mb-3"></i>
                            <h5>No investment predictions yet</h5>
                            <p class="text-muted">Try our investment prediction feature</p>
                            <a href="{{ url_for('investment_prediction') }}" class="btn btn-success">
                                <i class="fas fa-money-bill-trend-up me-2"></i>Predict Investment
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Company Comparisons Tab -->
                    <div class="tab-pane fade" id="comparison" role="tabpanel">
                        {% if company_comparisons %}
                        <div class="table-responsive mt-3">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Company 1</th>
                                        <th>Company 2</th>
                                        <th>Return 1</th>
                                        <th>Return 2</th>
                                        <th>Recommended</th>
                                        <th>Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for comp in company_comparisons %}
                                    <tr>
                                        <td>{{ comp.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <strong>{{ comp.company1.name }}</strong><br>
                                            <small class="text-muted">{{ comp.company1.symbol }}</small>
                                        </td>
                                        <td>
                                            <strong>{{ comp.company2.name }}</strong><br>
                                            <small class="text-muted">{{ comp.company2.symbol }}</small>
                                        </td>
                                        <td>
                                            <span class="{{ 'text-success' if comp.company1_predicted_return > 0 else 'text-danger' }}">
                                                {{ "%.2f"|format(comp.company1_predicted_return) }}%
                                            </span>
                                        </td>
                                        <td>
                                            <span class="{{ 'text-success' if comp.company2_predicted_return > 0 else 'text-danger' }}">
                                                {{ "%.2f"|format(comp.company2_predicted_return) }}%
                                            </span>
                                        </td>
                                        <td>
                                            {% if comp.recommended_company_id == comp.company1_id %}
                                                <span class="badge bg-success">{{ comp.company1.name }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ comp.company2.name }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ (comp.confidence_score * 100)|round }}%">
                                                    {{ (comp.confidence_score * 100)|round }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-balance-scale fa-3x text-muted mb-3"></i>
                            <h5>No company comparisons yet</h5>
                            <p class="text-muted">Compare companies to find better investment options</p>
                            <a href="{{ url_for('company_comparison') }}" class="btn btn-warning">
                                <i class="fas fa-balance-scale me-2"></i>Compare Companies
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-question-circle me-2"></i>How to Use AI Stock Analyzer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-upload me-2"></i>CSV Upload</h6>
                        <p class="small">Upload historical stock data in CSV format for AI-powered price predictions. Supports various column formats.</p>
                        
                        <h6><i class="fas fa-money-bill-trend-up me-2"></i>Investment Prediction</h6>
                        <p class="small">Select a company and investment amount to get profitability predictions with confidence scores and risk analysis.</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-balance-scale me-2"></i>Company Comparison</h6>
                        <p class="small">Compare two companies side-by-side to determine which offers better investment potential.</p>
                        
                        <h6><i class="fas fa-brain me-2"></i>AI Analysis</h6>
                        <p class="small">Our system uses advanced machine learning models including Linear Regression, Ridge, Lasso, and Random Forest for accurate predictions.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="card mt-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="fas fa-robot me-2"></i> StockMind Copilot</h5>
  </div>

  <div id="chat-container" class="card-body" style="max-height:400px; overflow-y:auto; font-family:monospace;"></div>

  <div class="card-footer">
    <div class="input-group">
      <input id="user-input" class="form-control" placeholder="Type your message..." />
      <button id="send-btn" type="button" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const chat = document.getElementById('chat-container');

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function append(who, text){
    const row = document.createElement('div');
    row.className = 'mb-2';
    row.innerHTML = `<b>${who}:</b> ${escapeHtml(text)}`;
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  async function sendMessage(){
    const message = input.value.trim();
    if(!message) return;

    append('You', message);
    input.value = '';
    input.focus();
    sendBtn.disabled = true;

    try {
      const res = await fetch('/chatbot', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await res.json();
      append('Bot', data.response || 'Sorry, something went wrong.');
    } catch (err) {
      append('Bot', 'Error: ' + err.message);
    } finally {
      sendBtn.disabled = false;
    }
  }

  // Click to send
  sendBtn.addEventListener('click', sendMessage);

  // ENTER to send (no Shift needed)
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // keep compatibility if you still have onclick="sendMessage()"
  window.sendMessage = sendMessage;
});
</script>
{% endblock %}
